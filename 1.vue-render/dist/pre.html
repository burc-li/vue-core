<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <style>
    #myPre {
      border: 4px solid #f00;
    }
    .temp_hr {
      display: inline-block;
      margin: 0;
      border: 1px solid #de5e60;
    }
    .temp_hr::after {
      content: attr(data-cont);
      text-decoration: attr(data-text);
      text-decoration: underline line-through;
    }

    .temp_input {
      width: 80px;
      display: inline-block;
      border: 1px solid #de5e60;
      /* border: none; */
      color: #2465ff;
      background-color: transparent;
      text-decoration: underline line-through;
    }
  </style>

  <body>
    <button onclick="getValue()">获取value</button>
    <button onclick="setValue()">设置value</button>
    <button onclick="focusOrSelect()">聚焦选择</button>
    <span>123</span>
    <!-- <pre id="myPre" contenteditable="plaintext-only">文本123</pre> -->

    <!-- 出现光标丢失问题-->
    <!-- <pre
      id="myPre"
      contenteditable="plaintext-only"
    ><span>span<span>嵌套span</span></span><a contenteditable="false" id="9r043ur49"  href="javascript:;" style="color: #f00">百度一下</a><a contenteditable="false" id="9r043ur49"  href="javascript:;" style="color: #f00">百度一下</a><span>标签内容</span></pre> -->

    <!--  如果最后一个是hr标签，光标在hr标签后面。第一次的回车事件是失效的，非第一次都正常
          如果文本中间有一个hr标签，光标在hr标签后面。回车之后，光标没有自动定位
          记得改下样式 -->
    <!-- <pre
      id="myPre"
      contenteditable="plaintext-only"
    >我需要<hr value="开立账户" class="temp_hr" data-cont="分隔线1" />，然后<hr value="存款"   class="temp_hr" data-cont="分隔线2"/></pre> -->

    <pre
      id="myPre"
      contenteditable="plaintext-only"
    >我需要<input value="开立账户" disabled class="temp_input" data-cont="分隔线1" /><input value="开立账户" disabled class="temp_input" data-cont="分隔线1" />，然后<input value="存款" disabled  class="temp_input" data-cont="分隔线2"/></pre>

    <script src="vue.js"></script>
    <script defer>
      const myPre = document.querySelector('#myPre')
      const list = genChildren(myPre.childNodes)
      const multiText = handleSplitArr(list)

      console.log('innerText', JSON.stringify(myPre.innerText))
      console.log('textContent', JSON.stringify(myPre.textContent))
      console.log('list', list)
      console.log('multiText', multiText)

      // 获取 Selection 对象
      function getSelection() {
        const selection = window.getSelection()
        const focusNode = selection?.focusNode
        const focusOffset = selection?.focusOffset
        const focusText = focusNode?.textContent
        return { focusNode, focusOffset, focusText }
      }
      // 设置光标位置
      function setRange(start, end) {
        const range = document.createRange()
        if (start) {
          const { node, offset } = start
          range.setStart(node, offset)
        }
        if (end) {
          const { node, offset } = end
          range.setEnd(node, offset)
        }
        const selection = window.getSelection()
        selection.removeAllRanges()
        selection.addRange(range)
      }

      function handleSplitArr(list) {
        let _arr = []
        let text = ''

        list.forEach((item, index) => {
          console.log('item.tagName', item.tagName)
          // 当前项不是 a标签 && 当前项是最后一个元素 或 下一项是存在&&下一项是a标签
          if (item.tagName !== 'A' && (index === list.length - 1 || list[index + 1].tagName === 'A')) {
            text += item.text
            _arr.push({
              category: 'normal',
              label: text,
            })
            text = ''
            return
          }
          if (item.tagName === 'A') {
            _arr.push({
              category: 'hyperlink',
              label: item.text,
              // ciCode: data.ciCode,
              // diagramId: _this.currDiagramId,
              // dirType: _this.getDirType,
            })
            text = ''
          } else {
            text += item.text
          }
        })
        return _arr
      }

      function gen(child) {
        // 如果是元素 && 不是a标签
        if (child.nodeType === 1 && child.nodeName !== 'A') {
          return genChildren(child.childNodes)
        } else if (child.nodeType === 1 && child.nodeName === 'A') {
          return [
            {
              ciCode: child.id,
              tagName: child.nodeName,
              text: child.textContent,
            },
          ]
        }
        // 如果是文本
        else if (child.nodeType === 3) {
          return [
            {
              tagName: child.nodeName,
              text: child.textContent,
            },
          ]
        }
      }
      function genChildren(children) {
        children = Array.from(children)
        let list = []
        children.map(child => {
          list.push(...gen(child))
        })
        return list
      }

      function getValue() {
        console.log('myPre', myPre.innerText)
      }
      function setValue() {
        myPre.innerText = '文本\n'
      }

      myPre.addEventListener('click', function (e) {
        return
        // 禁用enter默认事件
        const selection = window.getSelection()
        const focusNode = selection?.focusNode
        const focusOffset = selection?.focusOffset
        if (focusNode) {
          // 文本填充
          const startText = focusNode.textContent.slice(0, focusOffset)
          const endText = focusNode.textContent.slice(focusOffset)
          const text = startText + '\n' + endText
          console.log(text)
          focusNode.textContent = text

          // 移动光标位置
          var range = document.createRange()
          range.setStart(focusNode, focusOffset + 1)
          selection.removeAllRanges()
          selection.addRange(range)
        }
      })

      // false：仅聚焦  true：选择范围
      function focusOrSelect(select = false) {
        var range = document.createRange()
        range.selectNodeContents(myPre)
        if (!select) {
          range.collapse(false)
        }
        var sel = window.getSelection()
        sel.removeAllRanges()
        sel.addRange(range)
      }

      // 获取光标位置
      const getCursorIndex = () => {
        const selection = window.getSelection()
        return selection?.focusOffset
      }

      // 获取节点
      const getRangeNode = () => {
        const selection = window.getSelection()
        return selection?.focusNode
      }

      // 获取 @ 用户
      const getAtUser = () => {
        const content = getRangeNode()?.textContent || ''
        const regx = /@([^@\s]*)$/
        const match = regx.exec(content.slice(0, getCursorIndex()))
        if (match && match.length === 2) {
          return match[1]
        }
        return undefined
      }
    </script>
  </body>
</html>
